# Prompt Archive

本文件整理了你在当前会话中输入的**用户 prompt**（按时间顺序）。

## 1. 论文复现总提示（首条长 prompt）

```text
下面是对一篇论文的复现提示词：
```

```markdown
复现 Xiao 等 (2024) 的 **MD Diffusion** 模型是一个非常棒的选择。这篇论文的核心是将条件去噪扩散概率模型（Conditional DDPM）应用于 3D 地震数据的同步去噪和超分辨率。

为了帮助你顺利写代码并复现，我将这篇论文的整个工作流程拆解为 **4 个核心步骤**。你可以按照这个流程来构建你的代码库：

### 第一步：数据准备与退化模拟 (Data Preparation)
由于是基于深度学习的生成模型，训练阶段依然需要“干净数据”和“退化数据”的配对，模型将学习如何从退化数据中恢复出干净数据。

1.  **准备高分辨率无噪数据 ($X_{gt}$):** 使用合成的 3D 清晰地震数据作为 Ground Truth（基础真值）。
2.  **生成低分辨率含噪数据 ($X_{input}$ / $c$):** 通过退化函数 $F_{cor}$（例如：降采样/滤波 + 添加高斯或随机复杂噪声）对 $X_{gt}$ 进行处理，生成退化数据。这个 $X_{input}$ 在后续流程中将作为**条件先验 ($c$)**。
3.  **数据切块 (Patching):** 为了显存能够承受，将 3D 数据体切割成小块。论文中训练使用的 3D Patch 大小为 **$64 \times 64 \times 64$**。

### 第二步：网络结构搭建 (Network Architecture - 3D U-Net)
你需要搭建一个用于预测噪声的去噪网络 $\phi_\theta$。
1.  **3D 卷积化:** 将经典的 DDPM U-Net 中的所有 2D 卷积、上采样和下采样层全部替换为 **3D 卷积**，以适应 3D 地震数据体的通道和维度。
2.  **移除注意力机制 (Attention-free):** 这是论文的一个重要工程细节。为了让网络具有**尺度不变性（Scale-invariant）**，以便能在 $64^3$ 的块上训练，但能在 $128^3$ 或更大的实际数据上推理，**必须移除 U-Net 中的 Attention 模块**。
3.  **多输入通道:** 网络的输入应该包括三个部分拼接或融合：(1) 退化的地震数据块 $c$；(2) 当前时间步的含噪图像 $x_t$；(3) 噪声水平 $\gamma_t$ 的嵌入表示。
4.  **上采样策略:** 使用随机三线性插值 (trilinear) 和最近邻插值 (nearest-neighbor) 将低分辨率图像上采样到目标分辨率。

### 第三步：训练阶段 (Training Stage - 连续噪声采样)
这是 MD Diffusion 最核心的训练算法（区别于传统离散步长 DDPM）。目标是训练网络 $\phi_\theta$ 根据条件 $c$ 准确预测加入的噪声 $\epsilon$。

**训练循环伪代码逻辑****：**
1.  从数据集中随机抽取一对数据：干净数据 $x_0$ 和 退化数据 $c$。
2.  **连续噪声采样:** 随机抽取一个时间步 $t \in \{1, \dots, T\}$。计算出传统的 $\alpha_{t-1}$ 和 $\alpha_t$，然后**从均匀分布 $U(\alpha_{t-1}, \alpha_t)$ 中随机采样一个连续的噪声水平 $\gamma$**。
3.  **前向加噪:** 从标准正态分布采样噪声 $\epsilon \sim \mathcal{N}(0, I)$。计算加噪后的目标图像：
    $$\tilde{x} = \sqrt{\gamma} x_0 + \sqrt{1 - \gamma} \epsilon$$
4.  **网络预测与损失计算:** 将 $(c, \tilde{x}, \gamma)$ 输入到网络 $\phi_\theta$ 中，预测噪声。计算损失函数（通常是 L1 或 L2 损失）：
    $$Loss = \| \phi_\theta(c, \tilde{x}, \gamma) - \epsilon \|_p^p$$
5.  **反向传播:** 使用 Adam 优化器更新网络权重 $\theta$。

**论文提供的超参数****：**
*   **Batch size:** 8
*   **训练总步数 (Train steps):** 400,000
*   **优化器:** Adam (Learning rate = 1e-4)
*   **U-Net 深度乘数 (Depth multipliers):** 1, 2, 4, 8, 8

### 第四步：推理与加速采样阶段 (Sampling Stage - DDIM 加速)
在实际应用或测试时，你只有退化的输入数据 $c$，需要从纯噪声中一步步恢复出高清的 $x_0$。为了避免几千步的漫长采样，你需要实现 DDIM 加速策略。

**加速采样伪代码逻辑****：**
1.  生成与目标数据相同尺寸的纯高斯噪声 $x_T \sim \mathcal{N}(0, I)$。
2.  **定义采样序列 $\tau$:** 假设原扩散步数 $T=1000$，我们为了加速，使用**对数采样 (Logarithmic sampling)** 生成一个长度为 $L$（例如 $L=100$）的子序列 $\tau$。
3.  **反向迭代循环:** 按照子序列 $\tau$ 从大到小倒序遍历：
    *   如果不是最后一步，产生随机噪声 $z \sim \mathcal{N}(0, I)$；如果是最后一步，$z=0$。
    *   将 $(c, x_t, \gamma_t)$ 喂入训练好的网络 $\phi_\theta$，预测噪声。
    *   根据 DDIM 的非马尔可夫链公式（根据论文调整后的公式），利用网络预测的噪声、当前的 $x_t$、加速调整后的方差 $\sigma_{\tau_i}$ 来计算出 $x_{t-1}$。
    *   更新当前的状态为 $x_{t-1}$，继续循环直到 $t=0$。
4.  **输出结果:** 最终得到的 $x_0$ 即为同时完成了去噪和超分辨率的 3D 地震数据。

**复现的两个关键避坑点：**
*   **不需要实际数据的高清标签：** 训练完全在合成数据上完成（模型学会了映射关系和分布），推理时直接输入需要处理的Field Data即可，实现无监督泛化。
*   **对数采样很重要：** 论文对比了线性、二次和对数序列，结果表明**对数采样（Logarithmic）**在跳步加速时对地震数据的结构和指标（如 FID、SSIM）损伤最小，能够提速10倍。在写代码时，生成推步子序列记得用 log 函数分配。
```

补充要求（同一条消息中）：

```text
数据位于：/home/llp/data/Resolution/seismicSuperResolutionData的nx2和sx文件夹中，分别是低分辨率数据和高分辨率数据

XIAO_README.md是这篇论文的READM.md文件，你不需要配置环境，只是去调研这些链接，并帮助我复现它的代码

要求如下：
1. 必须要创建configs/config.yaml控制参数，具体参考：/home/llp/data/Resolution/seismic_liif的结构
2. 请你根据上述内容，写出如何复现这篇论文代码的流程与框架，都写到codex.md文件中
```

## 2. 代码补全（2D 约束）

```text
请你根据已有的config.yaml和codex.md，补全代码，需要指明的是，论文中说的是3d数据，而这里只需复现2d数据即可，请注意代码的简洁与连贯，要求所有参数都必须从config.yaml中读取
```

## 3. 运行方式咨询

```text
如何运行？这段代码
```

## 4. sample 与 eval 区别 + 报错排查

```text
我有一些好奇sample.py和eval.py的区别是什么
...（附运行日志与报错）
我运行python sample.py正常，但是运行python eval.py报错，请你检查
```

## 5. synthetic 可视化 notebook

```text
然后，我想看看预测的效果如何，请你在/home/llp/data/Resolution/SeismicDiffusion_Resolution路径下新建view.ipynb

读取预测的数据与原始低分辨率数据和高分辨率数据，进行绘图
比如读取runs/samples文件夹下的文件名字为'0008_pred.dat'，再去数据路径下寻找其低分辨率数据和高分辨率数据，然后读取这3个文件。我要求读取samples文件夹下的所有预测数据文件
最后再绘制出来多行3列的子图
```

## 6. 数据泄露问题

```text
我有些好奇，这些samples产生的数据，是被泄露到训练集了嘛，还是在训练时就已经隔开了？
```

## 7. field 可视化 notebook（4x2）

```text
好的，我现在想请你完成view_field.ipynb文件，它这次读取的是
/home/llp/data/Resolution/seismicSuperResolutionData/field
文件，

这次是4行2列，原始数据与经过网络处理后的高分辨率数据
```

## 8. reshape 方向修正

```text
你的rehsape反了，请你重新修改view_field.ipynb
```

## 9. 增加频谱列（4x3）

```text
然后，我想要你给view_field.ipynb添加新的功能，即绘制原始数据和网络输出后数据的频谱，即将4行2列改为4行3列，其中最后一个marmousi数据不专职，其他数据专职

绘制频谱要求：
1. 横坐标：0~60Hz
2. 总坐标：归一化后的幅值
3. legend 表示原始数据和高分辨率后的数据
```

## 10. 频谱实现参考

```text
你画的频谱不太对劲，请参考下面这段代码绘制频谱i：
...（附完整参考代码）
```

## 11. 显示与频谱修正

```text
好的，现在已经很好了，但是还有问题：

1. 前三个数据需要转置画图展示
2. 最后一个数据不需要转置
3. 且最后一个数据的频谱有问题没有显示
```

## 12. README 编写

```text
请你基于codex.md和XIAO_README.mc，写一个README.md，要求介绍这个项目的概况，符合github开源README.md的美观简洁
```

## 13. 本次归档请求

```text
我想将我这个会话所使用的提示词prompt，都存放prompt.md中，记得美观简洁展示
```

